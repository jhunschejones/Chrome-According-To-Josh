const leeches = ["講義", "潰れる", "後悔", "披露", "関係", "挑発", "修理", "表札", "行動", "調節", "焦る", "俯く", "内緒", "正直", "表現", "期待", "特技", "関わる", "沈黙", "想像", "重ねる", "調査", "責める", "威圧", "展開", "布巾", "沈む", "相撲", "ばらす", "溢れる", "風景", "衝突", "悔しい", "流れる", "非常口", "装う", "与える", "応用", "余裕", "限界", "内容", "傷", "支店", "歪む", "呟く", "没収", "建造", "海岸", "時刻", "溜める", "加工", "転勤", "特急", "数える", "うっとり", "認める", "彫刻", "バレバレ", "布", "発表", "職員", "納得", "習慣", "機転", "様子", "直接", "構わない", "連休", "素直", "挑む", "冴える", "勝利", "壊す", "合格", "縮む", "技", "豪華", "居候", "許可", "諦める", "危篤", "額", "口座", "否定", "刻む", "焼き増し", "交わる", "急行", "表情", "Kanji: 誘", "Kanji: 甫", "Kanji: 寧", "Kanji: 績", "Kanji: 亍", "Kanji: 仮", "Kanji: 幻", "Kanji: 怯", "Kanji: 謎", "Kanji: 壮", "Kanji: 紹", "Kanji: 及", "Kanji: 幸", "Kanji: 従", "Kanji: 筋", "Kanji: 采", "Kanji: 達", "Kanji: 認", "Kanji: 巷", "Kanji: 護", "Kanji: 咅", "Kanji: 亭", "Kanji: 縁", "Kanji: 惜", "Kanji: 曽", "Kanji: 午", "Kanji: 組", "Kanji: 貫", "Kanji: 氐", "Kanji: 続", "Kanji: 給", "Kanji: 昏", "Kanji: 借", "Kanji: 御", "Kanji: 莫", "Kanji: 測", "Kanji: 科", "Kanji: 需", "Kanji: 懸", "Kanji: 式", "Kanji: 条", "Kanji: 寮", "Kanji: 卸", "Kanji: 遭", "Kanji: 吉", "Kanji: 統", "Kanji: 成", "Kanji: 矛", "Kanji: 宛", "Kanji: 告", "Kanji: 怪", "Kanji: 察", "Kanji: 矢", "Kanji: 辟", "Kanji: 除", "Kanji: 秀", "Kanji: 偶", "Kanji: 適", "Kanji: 弋", "Kanji: 邪", "Kanji: 携", "Kanji: 戒", "Kanji: 或", "Kanji: 耐", "Kanji: 制", "Kanji: 険", "Kanji: 管", "Kanji: 是", "Kanji: 勘", "Kanji: 竟", "Kanji: 肋", "Kanji: 丰", "Kanji: 任", "Kanji: 奉", "Kanji: 律", "Kanji: 設", "Kanji: 透", "Kanji: 郎", "Kanji: 結", "Kanji: 仕", "Kanji: 尊", "Kanji: 射", "Kanji: 経", "Kanji: 委", "Kanji: 候", "Kanji: 吏", "班", "技術", "陸", "Kanji: 辞", "Kanji: 意", "Kanji: 脇", "Kanji: 精", "済む", "汚れる", "閉店", "合計", "保健室", "Kanji: 故", "Kanji: 伎", "Kanji: 届", "Kanji: 宣", "販売", "位置", "Kanji: 捜", "Kanji: 惑", "Kanji: 于", "宴会", "苦しい", "予習", "尖る", "Kanji: 温", "Kanji: 保", "Kanji: 湿", "間もない", "壊れる", "書類", "工", "使用", "Kanji: 尉", "Kanji: 笥", "Kanji: 提", "Kanji: 優", "Kanji: 昆", "Kanji: 胡", "Kanji: 壊", "Kanji: 彳", "術", "真似", "復習", "Kanji: 爰", "Kanji: 診", "Kanji: 代", "Kanji: 粗", "Kanji: 験", "試練", "人類", "遅刻", "Kanji: 失", "Kanji: 浴", "Kanji: 虚", "Kanji: 司", "Kanji: 弔", "Kanji: 感", "Kanji: 泉", "Kanji: 輩", "惑わす", "困る", "発明", "設計", "終了", "状態", "Kanji: 冴", "Kanji: 陽", "Kanji: 積", "Kanji: 妾", "Kanji: 預", "Kanji: 防", "Kanji: 係", "毛皮", "無駄", "高木", "世紀", "慣れる", "瞳", "騒音", "物価", "軽い", "証", "Kanji: 戌", "Kanji: 効", "Kanji: 酸", "苦労", "祝日", "植える", "慰める", "Kanji: 剣", "Kanji: 訓", "Kanji: 士", "Kanji: 牧", "外見", "茶道", "量る", "Kanji: 益", "Kanji: 棒", "秘密", "珍しい", "警備", "Kanji: 功", "Kanji: 綺", "Kanji: 完", "Kanji: 戊", "Kanji: 垂", "Kanji: 箪", "Kanji: 途", "退院", "首を傾げる", "突然", "敵", "差", "Kanji: 等", "Kanji: 丈", "Kanji: 勤", "Kanji: 敢", "Kanji: 腹", "Kanji: 罰", "固まる", "特売", "都会", "当然", "脇", "都合", "野球", "敷金", "Kanji: 志", "Kanji: 隠", "Kanji: 関", "Kanji: 寄", "Kanji: 住", "Kanji: 役", "設備", "彫る", "ごまかす", "勝負", "偶然", "辞書", "Kanji: 昨", "Kanji: 宮", "Kanji: 速", "試す", "握力", "紺", "行う", "汽車", "割る", "書留", "Kanji: 令", "Kanji: 呆", "Kanji: 兆", "Kanji: 薔", "収入", "寂しい", "案内", "葬式", "情報", "中止", "黙る", "緊張", "Kanji: 章", "Kanji: 安", "Kanji: 帝", "原料", "沸かす", "辞める", "寺中", "便", "栄養素", "現れる", "真剣", "余計", "無視", "感心", "Kanji: 慣", "Kanji: 序", "Kanji: 否", "Kanji: 乱", "Kanji: 吐", "Kanji: 辛", "Kanji: 啇", "とっくに", "現像", "治る", "教師", "視線", "問", "Kanji: 菓", "Kanji: 交", "Kanji: 価", "Kanji: 緑", "Kanji: 童", "Kanji: 裕", "Kanji: 慢", "Kanji: 宴", "Kanji: 貰", "Kanji: 材", "Kanji: 放", "先日", "埋め立てる", "さわやか", "曲", "どれだけ", "拭く", "抱える", "Kanji: 伸", "Kanji: 憂", "Kanji: 漫", "Kanji: 技"];

const kanjiLeeches = leeches
  .filter((leech) => leech.startsWith("Kanji: "))
  .map((leech) => leech.replace("Kanji: ", ""));

const wordLeeches = leeches.filter((leech) => !leech.startsWith("Kanji: "));

console.log(`The jpdb-leeches extension is set up to track \x1b[34m${kanjiLeeches.length}\x1b[39m kanji leeches and \x1b[36m${wordLeeches.length}\x1b[39m word leeches 🐛`);

const isAnswerCardUrl = () => {
  return new URLSearchParams(window.location.search).has("c");
};

const reviewKind = () => {
  let reviewKind;
  // this means we're on a question card
  if (!isAnswerCardUrl() && document.querySelector(".answer-box .kind")) {
    reviewKind = document.querySelector(".answer-box .kind").textContent;
  }

  // this means we're on a kanji answer card
  if (reviewKind === undefined && isAnswerCardUrl() && document.querySelector(".result.kanji .kanji.plain")) {
    reviewKind = "Kanji";
  }

  // this means we're on a vocabulary answer card
  if (reviewKind === undefined && isAnswerCardUrl() && document.querySelector(".answer-box .plain .plain")) {
    reviewKind = "Vocabulary";
  }

  return reviewKind;
};

const outlineLeech = () => {
  if (!document.querySelector(".answer-box")) return;
  document.querySelector(".answer-box").style.outline = "thick solid red";
};

const warnOnLeech = () => {
  if (isAnswerCardUrl() && reviewKind() === "Kanji") {
    const kanji = decodeURIComponent(document.querySelector(".result.kanji .kanji.plain").href.replace("https://jpdb.io/kanji/", "").replace("#a", ""));
    if (kanjiLeeches.includes(kanji)) outlineLeech();
  }

  if (isAnswerCardUrl() && reviewKind() === "Vocabulary") {
    const word = document.querySelector(".answer-box .plain .plain").innerHTML
      .replace(/<rt>.*<\/rt>/g, "")
      .replace(/<\/?ruby>/g, "");
    if (wordLeeches.includes(word)) outlineLeech();
  }
};

const showAnswerButton = document.querySelector("#show-answer");
if (showAnswerButton) {
  showAnswerButton.addEventListener("click", () => {
    setTimeout(() => warnOnLeech(), 200);
  }, {once: true, passive: true});
}

warnOnLeech();
